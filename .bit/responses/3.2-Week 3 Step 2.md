---
files: n/a
stepType: IssueComment
scripts: n/a
week: 3
step: 2
name: Upload It
---

Week 3 Step 2 ⬤◯◯◯◯◯◯◯◯ | 🕐 Estimated completion: 5-20 minutes

## Upload it!
*This week, you will be going through steps to upload images to blob storage using Azure's SDK.*

### ✅  Task:

- [ ]  Receive an image from a POST request using parse-multipart
- [ ]  Upload an image using @azure/blob SDK
- [ ]  Name the image `test.png`

### Before we start:

- Make sure you have an **[Azure Subscription](https://azure.microsoft.com/en-us/free/)** so we can utilize the amazing features of Microsoft Azure Functions (It's free!) 🤩
- **Register** for an account on **[Online Convert](https://www.online-convert.com/register)** (with the free version), as we will be using this API convert our images
- If you want to host your website somewhere, check out [Repl.it](https://repl.it/languages/html), or you can just have your project run [locally](https://marketplace.visualstudio.com/items?itemName=ritwickdey.LiveServer)

### Creating a Function App

We're going to have a lot of triggers in this project, so let's get started by [creating a Function App](https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function)! Follow those steps to create the Function App, and then create the first HTTP trigger (this will upload our image).

> **Note**: it will be helpful if you keep track of these strings for reference later in the project: Storage account name (found in "Hosting"), Function app name, Resource Group

Before we start coding the trigger, though, we need to install the following `npm` packages/libraries:

1. `parse-multipart`
2. `node-fetch`
3. `@azure/storage-blob`

> **Tip**: The Azure Storage Blob client library is going to be a key piece of the project. After all, it's about blobs!

<details>
<summary>:question: How do I install `npm` packages?</summary>
</br>

Click on the "Console" tab in the left panel under "Development Tools".

![https://user-images.githubusercontent.com/69332964/99189070-59e31d00-272d-11eb-80a4-17444e5fac65.png](https://user-images.githubusercontent.com/69332964/99189070-59e31d00-272d-11eb-80a4-17444e5fac65.png)

Inside the console (shown on the right panel), type in the following commands:

`npm init -y` <br />
[`npm install parse-multipart`](https://www.npmjs.com/package/parse-multipart) <br />
[`npm install node-fetch`](https://www.npmjs.com/package/node-fetch) <br />
[`npm install @azure/storage-blob`](https://www.npmjs.com/package/@azure/storage-blob) <br />

</details>

### Writing our *First* Azure Function to Upload an Image

⬇ **Some housekeeping...**

- For the function to work, we have to initialize the packages/libraries we installed in the beginning of part 1.
- Take note of the `process.env` value being assigned to `connectionstring` in the code below (*Line 3*). Use this [tutorial](https://docs.microsoft.com/en-us/azure/azure-functions/functions-how-to-use-azure-function-app-settings) to add in your own secret strings from your storage container.
    - The storage container is the one you created in step 1. Navigate to it and find your secret strings.

<details>
<summary>:question: How do I find my secret strings?</summary>
</br>

![https://user-images.githubusercontent.com/69332964/99161798-ba3d7480-26c3-11eb-8e55-eac4bd4cb174.png](https://user-images.githubusercontent.com/69332964/99161798-ba3d7480-26c3-11eb-8e55-eac4bd4cb174.png)

![https://user-images.githubusercontent.com/69332964/99161822-ec4ed680-26c3-11eb-8977-f12beb496c24.png](https://user-images.githubusercontent.com/69332964/99161822-ec4ed680-26c3-11eb-8977-f12beb496c24.png)

- Keep these safe, and use the connection string in the corresponding variable in the code.
- *Note: You'll need to store other strings in environment variables later on as well*

</details>

</br>

Let's start just by initializing a few variables we'll need. In your `initializing.js` file: 

```js
var multipart = require("parse-multipart")
const connectionString = process.env.AZURE_STORAGE_CONNECTION_STRING;
const { BlobServiceClient } = require("@azure/storage-blob");
```

⬇ **The main block of code**

- Be sure to name your image file as `test.png` or `test.jpg` for testing purposes.
- The `parse-multipart` library is being used in lines 5-10 to parse the image from the POST request we will later make with the frontend; refer to the documentation linked above.
- Some if-else logic is used from lines 12-20 to determine the file extension.
- We then call the `uploadFile()` function in line 22.

`uploadTrigger.js`:

```js
module.exports = async function (context, req) {
    context.log('JavaScript HTTP trigger function processed a request.');
    var boundary = multipart.getBoundary(req.headers['content-type']);
    var body = req.body;
    var parsedBody = multipart.Parse(body, boundary);
    context.log(parsedBody);

    var filetype = parsedBody[0].type;
    if (filetype == "image/png") {
        ext = "png";
    } else if (filetype == "image/jpeg") {
        ext = "jpeg";
    } else {
        username = "invalidimage"
        ext = "";
    }

    var responseMessage = await uploadFile(parsedBody, ext);
    context.res = {
        body: responseMessage
    };
    console.log(responseMessage)
}
```

⬇ **Uploading the image blob to the "images" container**

Meanwhile, our `uploadFile` function will look like this:

```js
async function uploadFile(parsedBody, ext){
    const blobServiceClient = BlobServiceClient.fromConnectionString(connectionString);
    // Create a unique name for the container
    const containerName = "resource";

    console.log('\nCreating container...');
    console.log('\t', containerName);

    // Get a reference to a container
    const containerClient = blobServiceClient.getContainerClient(containerName);

    // Create the container
    const blobName = 'test' + ext;

    // Get a block blob client
    const blockBlobClient = containerClient.getBlockBlobClient(blobName);

    console.log('\nUploading to Azure storage as blob:\n\t', blobName);

    // Upload data to the blob
    const uploadBlobResponse = await blockBlobClient.upload(parsedBody[0].data, parsedBody[0].data.length);
    console.log("Blob was uploaded successfully. requestId: ", uploadBlobResponse.requestId);
    return "File Saved";    
}
```

<br />

### Test Your Work

To test your work, you'll be using Postman to send a POST request with an image attached to your url. You should see a response similar to the below:

```JSON
{
  "body" : "File Saved"
}
```

<details>
<summary>:question: How do I attach an image to my POST request?</summary>
</br>

1. Set your request method to `POST`.

![image](https://user-images.githubusercontent.com/49426183/120075487-4e669c00-c056-11eb-8049-d2e00c766525.png)

2. You will need to send body data with your request. The Body tab in Postman allows you to specify the data you need to send with a request. You can send various different types of body data to suit your API. Website forms often send data to APIs as multipart/form-data. You can replicate this in Postman using the form-data Body tab. Be sure to check File instead of Text, since we'll be posting an image instead of a JSON object.

![image](https://user-images.githubusercontent.com/49426183/120075704-393e3d00-c057-11eb-8d99-7dfe8d5fd584.png)

</details>