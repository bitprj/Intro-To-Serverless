---
files: n/a
stepType: checks
scripts: test.3.2.js
week: 3
step: 2
name: Upload It
---

Week 3 Step 2 ⬤◯◯◯◯◯◯◯◯ | 🕐 Estimated completion: 10-20 minutes

## Upload it!
*This week, you will be going through steps to upload images to blob storage using Azure's SDK.*

### ✅  Task:

- [ ]  Make sure you're on the `week2` branch
- [ ]  Receive an image from a POST request using parse-multipart
- [ ]  Upload an image using @azure/blob SDK by naming the image `test.png`
- [ ]  Commit your updated function code to `bunnimage/index.js`

### Creating a Function App

We're going to have a lot of triggers in this project, so let's get started by [creating a Function App](https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function)! Follow those steps to create the Function App, and then create the first HTTP trigger (this will upload our image).

> **Note**: it will be helpful if you keep track of these strings for reference later in the project: Storage account name (found in "Hosting"), Function app name, Resource Group

Before we start coding the trigger, though, we need to install some `npm` packages/libraries.

Click on the "Console" tab in the left panel under "Development Tools".

![https://user-images.githubusercontent.com/69332964/99189070-59e31d00-272d-11eb-80a4-17444e5fac65.png](https://user-images.githubusercontent.com/69332964/99189070-59e31d00-272d-11eb-80a4-17444e5fac65.png)

Inside the console (shown on the right panel), type in the following commands:

`npm init -y` <br />
[`npm install parse-multipart`](https://www.npmjs.com/package/parse-multipart) <br />
[`npm install node-fetch`](https://www.npmjs.com/package/node-fetch) <br />
[`npm install @azure/storage-blob`](https://www.npmjs.com/package/@azure/storage-blob) <br />

> **Tip**: The Azure Storage Blob client library is going to be a key piece of the project. After all, it's about blobs!

### Setting up your storage containers

Navigate to the storage account you created in the first step. If you don't know what it is, search "Storage Containers" in the query box in Azure portal.

We're going to need to create 2 new containers: "images" and "pdfs." Think of these as folders in the account.

![https://user-images.githubusercontent.com/69332964/99161767-75194280-26c3-11eb-8ad1-c19d63d37bbb.png](https://user-images.githubusercontent.com/69332964/99161767-75194280-26c3-11eb-8ad1-c19d63d37bbb.png)

![https://user-images.githubusercontent.com/69332964/99161780-8cf0c680-26c3-11eb-9bfc-78dc3262b038.png](https://user-images.githubusercontent.com/69332964/99161780-8cf0c680-26c3-11eb-9bfc-78dc3262b038.png)

You will need to upgrade your storage account because Event Grid Subscriptions will only work with a v2 version. Follow this [tutorial](https://docs.microsoft.com/en-us/azure/storage/common/storage-account-upgrade?tabs=azure-portal) to upgrade it.

### Writing our *First* Azure Function to Upload an Image

⬇ **Some housekeeping...**

- For the function to work, we have to initialize the packages/libraries we installed in the beginning of part 1.
- Take note of the `process.env` value being assigned to `connectionstring` in the code below (*Line 3*). Use this [tutorial](https://docs.microsoft.com/en-us/azure/azure-functions/functions-how-to-use-azure-function-app-settings) to add in your own secret strings from your storage container.
    - The storage container is the one you created when you started your Function App. Navigate to it and find your secret strings here:

    ![https://user-images.githubusercontent.com/69332964/99161798-ba3d7480-26c3-11eb-8e55-eac4bd4cb174.png](https://user-images.githubusercontent.com/69332964/99161798-ba3d7480-26c3-11eb-8e55-eac4bd4cb174.png)

    ![https://user-images.githubusercontent.com/69332964/99161822-ec4ed680-26c3-11eb-8977-f12beb496c24.png](https://user-images.githubusercontent.com/69332964/99161822-ec4ed680-26c3-11eb-8977-f12beb496c24.png)

    - Keep these safe, and use the connection string in the corresponding variable in the code.
    - *Note: You'll need to store other strings in environment variables later on in the tutorial*

Let's start just by initializing a few variables we'll need. In your `initializing.js` file: 

```js
var multipart = require("parse-multipart");
const { BlobServiceClient } = require("@azure/storage-blob");
const connectionstring = process.env["AZURE_STORAGE_CONNECTION_STRING"];
const account = "<YOUR ACCOUNT NAME>";
```

⬇ **The main block of code**

- Notice that we are able to name the file with the user's username in line 10 by receiving it from the header.
    - Later on in the JS, we will send the username in the header of the request.
- The `parse-multipart` library is being used in lines 4-11 to parse the image from the POST request we will later make with the frontend; refer to the documentation linked above.
- Some if-else logic is used from lines 13-22 to determine the file extension.
- We then call the `uploadBlob()` function in line 24.

`uploadTrigger.js`:

```js
module.exports = async function (context, req) {
    context.log('JavaScript HTTP trigger function processed a request.');

    var boundary = multipart.getBoundary(req.headers['content-type']);
    // get boundary for multipart data 
    var body = req.body;
    // get raw body
    var parts = multipart.Parse(body, boundary);
    // parse body
    var username = req.headers['username'];
    // get username from request header

    var filetype = parts[0].type;

    if (filetype == "image/png") {
        ext = "png";
    } else if (filetype == "image/jpeg") {
        ext = "jpeg";
    } else {
        username = "invalidimage"
        ext = "";
    }
    
    var result = await uploadBlob(parts, username, ext);
    // call upload function to upload to blob storage
}
```

⬇ **Uploading the image blob to the "images" container**

- Notice the `uploadBlob()` function! This is what uploads the parsed image to the specified "images" blob container.
    - Here's a [YouTube Video to help explain](https://youtu.be/Qt_VXM_fml4) the handy dandy library

`uploadBlob.js`:

```js
async function uploadBlob(img, username, filetype){
    // create blobserviceclient object that is used to create container client
    const blobServiceClient = await BlobServiceClient.fromConnectionString(connectionstring);
    // get reference to a container
    const container = "images";
    const containerClient = await blobServiceClient.getContainerClient(container);
    // create blob name
    const blobName = username + "." + filetype;
    // get block blob client
    const blockBlobClient = containerClient.getBlockBlobClient(blobName);
    const uploadBlobResponse = await blockBlobClient.upload(img[0].data, img[0].data.length);
}
```

<br />

### Frontend: The "upload" webpage

Next, create a static HTML page that will accept the image from the user and send to the Azure Function we just coded using Javascript.

**Note**: We're using the bare minimum code for the sake of keeping things simple, but you can see Emily's fantastic ✨*fancy*✨ webpage [here](https://github.com/emsesc/bunnimage/blob/main/upload.html).

`uploadImage.html`: 

```html
<form id="image-form" onsubmit="handle(event)" enctype="multipart/form-data">
   <input class="label" type="file" onChange="loadFile(event)" accept="image/x-png,image/jpeg" name="image"></input>
   <img id="output" class="img-fluid" src="img/logo.png"></img>
   <br></br>
   <input id="username" type="text" class="form-control" placeholder="Enter valid username">
   <br></br>
   <input class="boxed-btn3" type="submit" value="Submit Your Picture 📷"></input>
   <p id="submit">You haven't submitted anything.</p>
</form>
```

<br />

**Above we have:**

- Input box for the username (simple but *insecure* auth system)
- Button to submit

However, a static HTML webpage can't make a request to the Azure Function itself, which is where we're going to cook up some JS. 😯

### Frontend: Javascript for interacting with the Azure Function

This block of Javascript updates the preview thumbnail while getting the picture, gets the username, and sends them both over to the function we just coded.

First, `loadFile()` is called when the file input changes to display the thumbnail.

```jsx
async function loadFile(event){
    console.log("Got picture!");
    var image = document.getElementById("output");
    // Get image from output 
    image.src = URL.createObjectURL(event.target.files[0])
    // load inputted image into the image src and display
}
```

Then, `handle()` is called when the file is submitted to POST the image and username. The image is sent in the body, and username is sent as a header. *Lines 15-30*

`requestJS.js`:

```js
async function handle(event) {
    event.preventDefault();
    document.getElementById("output").src = "img/logo.png";
    console.log("Loading picture");
    var username = document.getElementById("username").value;
    if (username.includes(' ') == true || username == '') {
      alert("Invalid username. A username cannot contain a space.");
      window.location.reload();
      return;
    }

    document.getElementById("upload").src = "img/doneupload.gif";
    $('#submit').html(`Thank you for your image, use "${username}" to receive your pdf.`);

    var myform = document.getElementById("image-form");
        var payload = new FormData(myform);

        console.log("Posting your image...");
        const resp = await fetch("https://bunnimage1.azurewebsites.net/api/uploadTrigger?code=Ia/3vNYiimrORzxaZRGlmdm695dnnSpCP0qd7R1k1WaUeRO2JUfGtg==", {
            method: 'POST',
            headers: {
                'username' : username
            },
            body: payload
        });

        var data = await resp.json();
        console.log(data);
        console.log("Blob has been stored successfully!")
}
```

> Be sure to change the function url on Line 19 to the one of your upload image Function!

![https://user-images.githubusercontent.com/69332964/99188529-73369a00-272a-11eb-93df-04fdce5381df.png](https://user-images.githubusercontent.com/69332964/99188529-73369a00-272a-11eb-93df-04fdce5381df.png)

### Deploy your code

There are three options:

- Try doing it locally with the **live server extension** for VS Code
- Try [Azure Web Apps](https://azure.microsoft.com/en-us/services/app-service/web/)
- Try [repl.it](https://repl.it/languages/html)

### Update CORS Settings

> This is a crucial step!! 😱 If you don't change your CORS (Cross-origin resource sharing) settings, the POST request won't work. This tells the Function App what domains can access our Azure Function.

**Options:**

- **Recommended**: Change it to a wildcard operator (`*`), which allows *all* origin domains to make requests
    - Be sure to remove any other existing inputs before attempting to save with wildcard

        ![https://user-images.githubusercontent.com/69332964/99188905-6f0b7c00-272c-11eb-8142-f91882227c78.png](https://user-images.githubusercontent.com/69332964/99188905-6f0b7c00-272c-11eb-8142-f91882227c78.png)

- Change it to the domain you are using to host your code

### Home stretch! 🏃🏻‍♀️

**It's finally time to test our first step that our app will make!**

1. Navigate to your HTML page and submit an image

![https://user-images.githubusercontent.com/69332964/99189240-3cfb1980-272e-11eb-8896-e959f37480b3.png](https://user-images.githubusercontent.com/69332964/99189240-3cfb1980-272e-11eb-8896-e959f37480b3.png)

![https://user-images.githubusercontent.com/69332964/99189255-53a17080-272e-11eb-9cab-a73faf504b3f.png](https://user-images.githubusercontent.com/69332964/99189255-53a17080-272e-11eb-9cab-a73faf504b3f.png)

Go to the "images" storage container and check to see if your image is there!
*Error? Check the log in your Function*

![https://user-images.githubusercontent.com/69332964/99189316-9c592980-272e-11eb-9870-dbc1f9352599.png](https://user-images.githubusercontent.com/69332964/99189316-9c592980-272e-11eb-9870-dbc1f9352599.png)
